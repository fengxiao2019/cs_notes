
Redis集群的故障检测用于识别主节点或从属节点不再能被大多数节点接触到，然后通过将从属节点提升到主节点的角色来响应。当从属推广不可能时，集群就会处于错误状态，停止接收客户的查询。

如前所述，每个节点都有一个与其他已知节点相关的标志列表。有两个标志用于故障检测，它们被称为**PFAIL**和**FAIL**。PFAIL意味着可能的失败，是一种不被承认的失败类型。FAIL意味着一个节点正在失败，而且这种情况在固定的时间内被大多数主站确认。
- PFAIL标志：
当一个节点超过`NODE_TIMEOUT`时间无法到达时，该节点会用PFAIL标志标记另一个节点。主节点和从节点都可以将另一个节点标记为PFAIL，不管它是什么类型。
Redis集群节点的不可达性的概念是，我们有一个活动的ping（我们发出的ping还没有得到回复）等待超过`NODE_TIMEOUT`。为了使这个机制发挥作用，`NODE_TIMEOUT`必须比网络往返时间大。为了增加正常操作中的可靠性，一旦`NODE_TIMEOUT`的一半时间过后没有得到PING的回复，节点就会尝试与集群中的其他节点重新连接。这种机制确保了连接保持活力，所以断裂的连接通常不会导致节点之间的虚假故障报告。
- FAIL标志
单纯的PFAIL标志只是每个节点拥有的关于其他节点的本地信息，但它不足以触发从属推广。对于一个节点来说，PFAIL条件需要升级为FAIL条件，才能被认为是宕机。
正如本文的节点心跳部分所概述的，每个节点都向其他每个节点发送gossip 消息，包括一些随机的已知节点的状态。每个节点最终都会收到其他每个节点的一组节点标志。这样，每个节点都有一个机制来向其他节点发出关于他们所检测到的故障条件的信号。
当满足以下一组条件时，一个PFAIL条件被升级为FAIL条件。
某个节点，我们称之为A，有另一个节点B标记为PFAIL。
节点A通过 gossip 部分，从集群中大多数主站的角度收集关于B的状态的信息。
大多数主站在`NODE_TIMEOUT * FAIL_REPORT_VALIDITY_MULT`时间内发出了PFAIL或FAIL状态的信号。在目前的实现中，有效性系数被设置为**2**，所以这只是`NODE_TIMEOUT`时间的2倍）。
如果上述条件都是真的，节点A将 将该节点标记为FAIL。
向所有可到达的节点发送一个FAIL消息。
FAIL消息将迫使每个接收节点将该节点标记为FAIL状态，不管它是否已经将该节点标记为PFAIL状态。
注意，FAIL标志大多是单向的。也就是说，一个节点可以从PFAIL变成FAIL，但FAIL标志只有在以下情况下才能被清除。

- 节点已经可以到达，并且是一个Replica。在这种情况下，FAIL标志可以被清除，因为Replica不会被故障覆盖。
- 节点已经可以到达，并且是一个不为任何插槽服务的主站。在这种情况下，可以清除FAIL标志，因为没有插槽的主站并没有真正参与集群，而是在等待配置，以便加入集群。
- 该节点已经可以到达，并且是一个主站，但是过了很长时间（N倍于NODE_TIMEOUT），没有任何可检测到的从站晋升。在这种情况下，最好让它重新加入集群并继续。
值得注意的是，虽然PFAIL-\>FAIL转换使用了一种协议形式，但使用的协议是弱的。
节点在某个时间段内收集其他节点的意见，所以即使大多数主节点需要 "同意"，实际上这只是我们在不同时间从不同节点收集的状态，我们不确定，也不要求在某个时刻大多数主节点同意。然而，我们会丢弃那些旧的故障报告，所以故障是由大多数主站在一个**时间窗口内**发出的信号。
虽然每个检测到故障条件的节点都会使用故障消息对集群中的其他节点强制执行该条件，但没有办法确保该消息会到达所有节点。例如，一个节点可能检测到FAIL条件，但由于分区的原因，将无法到达任何其他节点。
然而，Redis集群的故障检测有一个有效性要求：最终所有的节点都应该同意某个节点的状态。有两种情况可以源于“脑裂”的状况。要么是一些少数节点认为该节点处于故障状态，要么是少数节点认为该节点不处于故障状态。在这两种情况下，最终集群都会对某个节点的状态有一个单一的看法。

情况1：如果大多数主站将一个节点标记为FAIL，由于故障检测和它产生的连锁效应，每一个其他节点最终都会将主站标记为FAIL，因为在指定的时间窗口内会有足够的故障报告。

情况2：当只有少数主站将一个节点标记为FAIL时，从站晋升将不会发生（因为它使用一个更正式的算法，确保每个人最终都知道晋升），每个节点将按照上面的FAIL状态清除规则清除FAIL状态（即在N倍NODE_TIMEOUT过后没有晋升）。

FAIL标志只是作为一个触发器，用于运行从属推广算法的安全部分。理论上，一个从站可以独立行动，在其主站无法到达时启动从站推广，并等待主站拒绝提供确认，如果主站实际上可以被大多数人到达。然而，PFAIL -\> FAIL状态的附加复杂性、弱协议以及FAIL消息迫使在集群的可达部分以最短的时间传播该状态，具有实际优势。由于这些机制，如果集群处于错误状态，通常所有的节点会在差不多的时间内停止接受写入。从使用Redis Cluster的应用程序的角度来看，这是一个理想的功能。同时，也避免了因本地问题而无法到达主节点的从属节点发起的错误的选举尝试（主节点在其他情况下可以被大多数其他主节点所到达）。

