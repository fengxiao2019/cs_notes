从属选举和晋升由从属节点处理，在master节点的帮助下，mater节点为要晋升的从属投票。当master从其至少一个具备成为主站前提条件的Replica来看处于失败状态时，就会发生从属选举。

为了让一个Replica晋升为master，它需要启动一个选举并赢得选举。如果主站处于失败状态，所有主站的从站都可以开始选举，但只有一个从站会赢得选举并晋升为主站。

当满足以下条件时，一个从站开始选举。
- 从站的主站处于FAIL状态。
- 主站在提供非零数量的槽位。
- 从属复制链路与主站断开的时间不超过给定的时间，以确保晋升的从属站的数据是合理的新鲜。这个时间是用户可配置的。
为了当选，从属机构的第一步是增加它的currentEpoch计数器，并请求主实例的投票。
从机通过向集群的每个主节点广播一个`FAILOVER_AUTH_REQUEST`包来请求投票。然后，它最多等待2倍于`NODE_TIMEOUT`的时间，等待回复的到来（但总是至少2秒）。
一旦一个主节点为一个给定的从属节点投票，并以`FAILOVER_AUTH_ACK`作出肯定的答复，它就不能再为同一个主节点的另一个从属节点投票，时间为`NODE_TIMEOUT*2`。在这段时间内，它将不能回复对同一主站的其他授权请求。这不是保证安全所必需的，但对于防止多个从站在同一时间被选举（即使是不同的configEpoch）是有用的，这通常是不希望的。

从属机构会丢弃任何`AUTH_ACK`回复，该回复的历时小于发送投票请求时的currentEpoch。这确保了它不会计算为以前的选举准备的投票。

一旦从属机构收到大多数主站的ACK，它就赢得了选举。否则，如果在`NODE_TIMEOUT`的2倍（但总是至少2秒）的时间内没有达到多数，选举就会被中止，在`NODE_TIMEOUT * 4`（总是至少4秒）之后，将再次尝试新的选举。

## 从属等级
只要主站处于FAIL状态，从站就会在尝试当选前等待一小段时间。该延迟的计算方法如下。

DELAY = 500毫秒 + 0到500毫秒之间的随机延迟 +
`SLAVE_RANK * 1000` milliseconds。
固定延迟确保我们等待FAIL状态在整个集群中传播，否则从机可能会在主站还没有意识到FAIL状态时试图当选，拒绝给予他们投票。/??

随机延迟是用来使从机不同步的，所以它们不太可能同时开始选举。

`SLAVE_RANK`是这个从站关于它从主站处理的复制数据量的等级。当主站失败时，从站会交换信息，以建立一个（尽力而为的）等级：具有最新复制偏移量的从站处于等级0，第二个最新的从站处于等级1，以此类推。通过这种方式，更新最多的从站试图在其他人之前当选。— 主要是偏移量

排名顺序不是严格执行的；如果一个排名较高的从属站未能当选，其他从属站将很快尝试。

一旦一个Replica赢得了选举，它就会获得一个新的独特的、增量的configEpoch，这个configEpoch比任何其他现有的master的都要高。它开始在ping和pong数据包中宣传自己是主站，为所服务的槽位集提供一个将胜过过去的configEpoch。

为了加快其他节点的重新配置，一个pong包被广播到集群的所有节点。目前无法到达的节点将最终被重新配置，当它们收到另一个节点的ping或pong包时，或者将收到另一个节点的UPDATE包，如果它通过心跳包发布的信息被检测到是过时的。

其他节点将检测到有一个新的主站服务于旧主站所服务的相同槽位，但具有更大的configEpoch，并将升级他们的配置。旧主站的从站（或者失败的主站，如果它重新加入集群的话）将不仅仅是升级配置，还将重新配置以从新主站进行复制。在接下来的章节中，将解释如何对重新加入集群的节点进行配置。

配置纪元在分区时的用处的实际例子
本节说明了如何使用纪元概念来使从属机构的晋升过程对分区更有抵抗力。

一个主站不再能无限期地到达。主站有三个从站A、B、C。
从属A在选举中获胜，被提升为主站。
一个网络分区使A对集群中的大多数人都不能使用。
从属B赢得了选举并被提升为主站。
一个分区使B对集群中的大多数人来说都是不可用的。
之前的分区被修复，A又可以使用了。
在这一点上，B已经停机，A又可以以主站的角色使用了（实际上UPDATE消息会及时重新配置，但这里我们假设所有UPDATE消息都丢失了）。同时，从属设备C将试图被选中，以便在B之上失效。

C将试图当选，并将成功，因为对于大多数主站来说，它的主站实际上是关闭的。它将获得一个新的增量 configEpoch。
A将不能声称自己是其哈希槽的master，因为其他节点已经有相同的哈希槽，与A发布的配置纪元相比，它的配置纪元更高（B的配置纪元）。
因此，所有的节点都将升级他们的表，把哈希槽分配给C，集群将继续其操作。
正如你在接下来的章节中所看到的，重新加入集群的陈旧节点通常会尽快得到关于配置变化的通知，因为只要它ping任何其他节点，接收器就会检测到它有陈旧的信息，并会发送一个UPDATE消息。
