ç¬¬äºŒç«  æ•°æ®æ¨¡å‹ä¸æŸ¥è¯¢è¯­è¨€ - part1
é‡‡ç”¨NoSQL æ•°æ®åº“çš„å› ç´ ï¼š
- æ¯”å…³ç³»æ•°æ®åº“æ›´å¥½çš„æ‰©å±•æ€§éœ€æ±‚ï¼ˆè‡ªåŠ¨åˆ†ç‰‡æœºåˆ¶ï¼‰ï¼ŒåŒ…æ‹¬æ”¯æŒè¶…å¤§æ•°æ®é›†æˆ–è¶…é«˜å†™å…¥ååé‡ã€‚ï¼ˆè‡ªåŠ¨åˆ†ç‰‡æœºåˆ¶-æ”¯æŒè¶…å¤§æ•°æ®é›†ï¼ŒLSMæ ‘æ•°æ®ç»“æ„ï¼ˆç¬¬ä¸‰ç« ï¼‰æ”¯æŒè¶…é«˜å†™å…¥ååé‡ï¼‰ã€‚
- æ›´çƒ­è¡·äºå¼€æºè½¯ä»¶ï¼ˆæ´»è·ƒçš„ç¤¾åŒºï¼‰è€Œä¸æ˜¯å•†ä¸šè½¯ä»¶ã€‚
- å…³ç³»æ¨¡å‹ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒä¸€äº›ç‰¹å®šçš„æŸ¥è¯¢ã€‚
- ä¸€äº›ä¸šåŠ¡åœºæ™¯éœ€æ±‚æ›´åŠ å…·æœ‰åŠ¨æ€å’Œè¡¨è¾¾åŠ›çš„æ•°æ®æ¨¡å‹ï¼Œå…³ç³»æ€§æ¨¡å‹çš„schemaæ— æ³•æä¾›å¾ˆå¥½çš„æ”¯æ’‘ã€‚
## æ–‡æ¡£æ¨¡å‹ä¸­çš„one to few ã€one to manyã€many to one ã€many to many
ï¼ˆ**è¦ä¸ºé¡¹ç›®ä¸­çš„æ•°æ®æ¨¡å‹è®¾è®¡å¯»æ‰¾ç†è®ºæ”¯æ’‘**ï¼‰
å…ˆè¯´ç»“è®º- æœ€ä½³å®è·µï¼š
- ğŸ‡ºğŸ‡³ä¼˜å…ˆä½¿ç”¨åµŒå…¥æ¨¡å‹ï¼Œé™¤éæœ‰ä»¤äººä¿¡æœçš„ç†ç”±ä¸è¿™æ ·åš
- ğŸª›éœ€è¦å•ç‹¬è®¿é—®ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸åµŒå…¥å®ƒçš„ä¸€ä¸ªä»¤äººä¿¡æœçš„ç†ç”±
- ğŸ¤æ”¯æŒåµŒå…¥ã€‚æ•°ç»„ä¸åº”è¯¥æ— é™åˆ¶åœ°å¢é•¿ã€‚å¦‚æœåœ¨ "å¤š "æ–¹é¢æœ‰è¶…è¿‡å‡ ç™¾ä¸ªæ–‡æ¡£ï¼Œå°±ä¸è¦åµŒå…¥å®ƒä»¬ï¼›å¦‚æœåœ¨ "å¤š "æ–¹é¢æœ‰è¶…è¿‡å‡ åƒä¸ªæ–‡æ¡£ï¼Œå°±ä¸è¦ä½¿ç”¨ObjectIDå¼•ç”¨çš„æ•°ç»„ã€‚é«˜cardinalityæ•°ç»„æ˜¯**ä¸åµŒå…¥**çš„ä¸€ä¸ªä»¤äººä¿¡æœçš„ç†ç”±ã€‚
- ğŸ”—ä¸è¦å®³æ€•åº”ç”¨çº§çš„è¿æ¥ï¼šå¦‚æœä½ æ­£ç¡®åœ°å»ºç«‹ç´¢å¼•å¹¶ä½¿ç”¨æŠ•å½±æŒ‡å®šå™¨ï¼ˆå¦‚ç¬¬äºŒéƒ¨åˆ†æ‰€ç¤ºï¼‰ï¼Œé‚£ä¹ˆåº”ç”¨çº§çš„è¿æ¥å‡ ä¹ä¸ä¼šæ¯”å…³ç³»å‹æ•°æ®åº“ä¸­çš„æœåŠ¡å™¨ç«¯è¿æ¥æ›´æ˜‚è´µã€‚
- ğŸ’¢åœ¨åèŒƒå¼æ—¶è¦è€ƒè™‘å†™/è¯»æ¯”ä¾‹ã€‚å¦‚æœä¸€ä¸ªå­—æ®µå¤§éƒ¨åˆ†æ˜¯è¢«è¯»å–çš„ï¼Œè€Œä¸”å¾ˆå°‘è¢«æ›´æ–°ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åèŒƒå¼çš„å€™é€‰è€…ï¼šå¦‚æœä½ åèŒƒå¼ä¸€ä¸ªç»å¸¸è¢«æ›´æ–°çš„å­—æ®µï¼Œé‚£ä¹ˆå¯»æ‰¾å’Œæ›´æ–°æ‰€æœ‰å®ä¾‹çš„é¢å¤–å·¥ä½œå¾ˆå¯èƒ½ä¼šå‹å€’ä½ ä»åèŒƒå¼ä¸­å¾—åˆ°çš„æ”¶ç›Šã€‚
- ğŸ¦…ä¸MongoDBä¸€æ ·ï¼Œä½ å¦‚ä½•å¯¹æ•°æ®è¿›è¡Œå»ºæ¨¡å®Œå…¨å–å†³äºä½ çš„ç‰¹å®šåº”ç”¨ç¨‹åºçš„æ•°æ®è®¿é—®æ¨¡å¼ã€‚ä½ æƒ³è¦ç»“æ„åŒ–ä½ çš„æ•°æ®ï¼Œä»¥åŒ¹é…ä½ çš„åº”ç”¨ç¨‹åºæŸ¥è¯¢å’Œæ›´æ–°çš„æ–¹å¼ã€‚
### one to few
```python
db.person.findOne()
{
  name: 'Kate Monster',
  ssn: '123-456-7890',
  addresses : [
     { street: '123 Sesame St', city: 'Anytown', cc: 'USA' },
     { street: '123 Avenue Q', city: 'New York', cc: 'USA' }
  ]
}
```
ä½¿ç”¨çš„æ–¹å¼ï¼šåµŒå…¥æ¨¡å‹ã€‚
ä¼˜ç‚¹ï¼šä¸€æ¬¡æŸ¥è¯¢å°±èƒ½è·å¾—æ‰€æœ‰æ•°æ®ã€‚
ç¼ºç‚¹ï¼šæ— æ³•å•ç‹¬è·å¾—åµŒå…¥æ¨¡å‹æ•°æ®ï¼Œä¾‹å¦‚ç°åœ¨æœ‰ä¸€ä¸ªä»»åŠ¡è·Ÿè¸ªç³»ç»Ÿï¼ŒPerson æ–‡æ¡£ä¸­åµŒå…¥äº†Task æ–‡æ¡£ã€‚ç°åœ¨æˆ‘æƒ³è·å–æ˜å¤©æ‰€æœ‰çš„ä»»åŠ¡ï¼Œå°±æ¯”è¾ƒå›°éš¾ã€‚
### one to many
æ›¿æ¢é›¶ä»¶è®¢è´­ç³»ç»Ÿä¸­çš„äº§å“é›¶ä»¶ã€‚æ¯ä¸ªäº§å“å¯èƒ½æœ‰å¤šè¾¾å‡ ç™¾ä¸ªæ›¿æ¢é›¶ä»¶ã€‚ä½ ä¼šæŠŠé›¶ä»¶çš„ObjectIDsæ”¾åœ¨äº§å“ Documentçš„ä¸€ä¸ªæ•°ç»„ä¸­ã€‚
```MongoDB
db.parts.findOne()
{
    _id : ObjectID('AAAA'),
    partno : '123-aff-456',
    name : '#4 grommet',
    qty: 94,
    cost: 0.94,
    price: 3.99

db.products.findOne()
{
    name : 'left-handed smoke shifter',
    manufacturer : 'Acme Corp',
    catalog_number: 1234,
    parts : [     // array of references to Part documents
        ObjectID('AAAA'),    // reference to the #4 grommet above
        ObjectID('F17C'),    // reference to a different Part
        ObjectID('D2AA'),
        // etc
    ]
```
ç„¶åä½ åœ¨åº”ç”¨å±‚é¢è¿›è¡Œè”ç»“ï¼š
```MongoDB
 // Fetch the Product document identified by this catalog number
> product = db.products.findOne({catalog_number: 1234});
   // Fetch all the Parts that are linked to this Product
> product_parts = db.parts.find({_id: { $in : product.parts } } ).toArray() ;
```
è¿™ç§å¼•ç”¨æ–¹å¼ä¸åµŒå…¥æ–¹å¼ç›¸æ¯”ï¼Œæœ‰ä¸€ç³»åˆ—äº’è¡¥çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚æ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æœç´¢å®ƒä»¬å¹¶ç‹¬ç«‹æ›´æ–°å®ƒä»¬ã€‚ä½¿ç”¨è¿™ç§æ¨¡å¼çš„ä¸€ä¸ªäº¤æ¢æ¡ä»¶æ˜¯å¿…é¡»æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ä»¥è·å¾—å…³äºäº§å“çš„éƒ¨ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚
è€Œä¸”è¿™ç§å¼•ç”¨æ¨¡å‹å¾ˆå®¹æ˜“è¡¨è¾¾å¤šå¯¹å¤šçš„å…³ç³»ã€‚
### one to Squillionsä¸€åˆ°åäº¿
ä¸€ä¸ª "ä¸€åˆ°æ•°åäº¿ "çš„ä¾‹å­å¯èƒ½æ˜¯ä¸€ä¸ª**æ”¶é›†ä¸åŒæœºå™¨çš„æ—¥å¿—ä¿¡æ¯çš„äº‹ä»¶æ—¥å¿—ç³»ç»Ÿ**ã€‚ä»»ä½•ç»™å®šçš„ä¸»æœºéƒ½å¯èƒ½äº§ç”Ÿè¶³å¤Ÿå¤šçš„æ¶ˆæ¯æ¥æº¢å‡º16MBçš„æ–‡æ¡£å¤§å°ï¼Œå³ä½¿ä½ å­˜å‚¨åœ¨æ•°ç»„ä¸­çš„åªæ˜¯ObjectIDã€‚è¿™å°±æ˜¯**Â "çˆ¶å¼•ç”¨ "**çš„å…¸å‹ç”¨ä¾‹--ä½ ä¼šæœ‰ä¸€ä¸ªä¸»æœºçš„æ–‡æ¡£ï¼Œç„¶åå°†ä¸»æœºçš„ObjectIDå­˜å‚¨åœ¨æ—¥å¿—ä¿¡æ¯çš„æ–‡æ¡£ä¸­ã€‚
```MongoDB
> db.hosts.findOne()
{
    _id : ObjectID('AAAB'),
    name : 'goofy.example.com',
    ipaddr : '127.66.66.66'
}

>db.logmsg.findOne()
{
    time : ISODate("2014-03-28T09:42:41.382Z"),
    message : 'cpu is on fire!',
    host: ObjectID('AAAB')       // Reference to the Host document
}
```

```MongoDB
  // å…ˆæ‰¾ä¸»æœºçš„æ–‡æ¡£
> host = db.hosts.findOne({ipaddr : '127.66.66.66'});  // assumes unique index
   // find the most recent 5000 log message documents linked to that host
> last_5k_msg = db.logmsg.find({host: host._id}).sort({time : -1}).limit(5000).toArray()
```
æ€»ç»“ï¼š
- å¦‚æœcardinalityæ˜¯ä¸€å¯¹ä¸€çš„ï¼Œå¹¶ä¸”ä¸éœ€è¦åœ¨çˆ¶å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¹‹å¤–è®¿é—®åµŒå…¥çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±åµŒå…¥Né¢ã€‚**embedding**
- å¦‚æœcardinalityæ˜¯ä¸€å¯¹å¤šï¼Œæˆ–è€…å¦‚æœNæ–¹å¯¹è±¡ç”±äºä»»ä½•åŸå› åº”è¯¥ç‹¬ç«‹ï¼Œåˆ™ä½¿ç”¨å¯¹Næ–¹å¯¹è±¡çš„æ•°ç»„å¼•ç”¨ã€‚ **child-referencing**,
- å¦‚æœcardinalityæ˜¯ä¸€å¯¹å¤šçš„è¯ï¼Œåœ¨N-sideå¯¹è±¡ä¸­ä½¿ç”¨å¯¹One-sideçš„å¼•ç”¨ã€‚ **parent-referencing**
### åŒå‘å¼•ç”¨ two reference
â€œoneâ€ side -\> â€œmanyâ€ side
â€œmanyâ€ side -\> â€œoneâ€ side
è¿˜æ˜¯ä»¥`task-tracking system`ä¸ºä¾‹
`People`é›†åˆï¼ˆcollectionï¼‰ ä¸­æ˜¯`Person` æ–‡æ¡£ã€‚
`tasks`é›†åˆä¸­æ˜¯`Task` æ–‡æ¡£ã€‚
ä¸€å¯¹å¤šçš„å…³ç³»ï¼šPeople -\> Taskã€‚
åº”ç”¨ç¨‹åºå°†éœ€è¦è·Ÿè¸ªä¸€ä¸ªäººæ‰€æ‹¥æœ‰çš„æ‰€æœ‰ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†éœ€è¦å¼•ç”¨äºº-\>ä»»åŠ¡ã€‚
```MongoDB
db.person.findOne()
{
    _id: ObjectID("AAF1"),
    name: "Kate Monster",
    tasks [     // array of references to Task documents
        ObjectID("ADF9"), 
        ObjectID("AE02"),
        ObjectID("AE73") 
        // etc
    ]
}

```

å¦ä¸€æ–¹é¢ï¼Œåœ¨å…¶ä»–ä¸€äº›æƒ…å†µä¸‹ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°†æ˜¾ç¤ºä¸€ä¸ªä»»åŠ¡åˆ—è¡¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªå¤šäººé¡¹ç›®ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼‰ï¼Œå®ƒéœ€è¦å¿«é€Ÿæ‰¾åˆ°å“ªä¸ªäººå¯¹æ¯ä¸ªä»»åŠ¡è´Ÿè´£ã€‚ä½ å¯ä»¥é€šè¿‡åœ¨`Task`æ–‡æ¡£ä¸­å¢åŠ ä¸€ä¸ªå¯¹`Person`çš„å¼•ç”¨æ¥ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ã€‚
```MongoDB
db.tasks.findOne()
{
    _id: ObjectID("ADF9"), 
    description: "Write lesson plan",
    due_date:  ISODate("2014-04-01"),
    owner: ObjectID("AAF1")     // Reference to Person document
}
```
åœ¨`Task`æ–‡æ¡£ä¸­åŠ å…¥é¢å¤–çš„ â€œowner"å¼•ç”¨ï¼Œæ„å‘³ç€å¯ä»¥å¿«é€Ÿè€Œå®¹æ˜“åœ°æ‰¾åˆ°ä»»åŠ¡çš„æ‰€æœ‰è€…ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€å¦‚æœä½ éœ€è¦å°†ä»»åŠ¡é‡æ–°åˆ†é…ç»™å¦ä¸€ä¸ªäººï¼Œä½ éœ€è¦**æ‰§è¡Œä¸¤ä¸ªæ›´æ–°ï¼Œè€Œä¸æ˜¯åªæœ‰ä¸€ä¸ª**(æ— æ³•ä¿è¯åŸå­æ€§)ã€‚å…·ä½“æ¥è¯´ï¼Œä½ å¿…é¡»åŒæ—¶æ›´æ–°ä»ä¸ªäººåˆ°ä»»åŠ¡æ–‡ä»¶çš„å¼•ç”¨ï¼Œä»¥åŠä»ä»»åŠ¡åˆ°ä¸ªäººçš„å¼•ç”¨ã€‚**ä½¿ç”¨è¿™ç§æ¨¡å¼è®¾è®¡æ„å‘³ç€ä¸å†å¯èƒ½é€šè¿‡ä¸€æ¬¡_åŸå­æ›´æ–°_å°†ä¸€ä¸ªä»»åŠ¡é‡æ–°åˆ†é…ç»™ä¸€ä¸ªæ–°çš„äºº**ã€‚
### åèŒƒå¼è®¾è®¡
åèŒƒå¼ - many to one
```MongoDB
db.products.findOne()
{
    name : 'left-handed smoke shifter',
    manufacturer : 'Acme Corp',
    catalog_number: 1234,
    parts : [     // array of references to Part documents
        ObjectID('AAAA'),    // reference to the #4 grommet above
        ObjectID('F17C'),    // reference to a different Part
        ObjectID('D2AA'),
        // etc
    ]
}
```
åèŒƒå¼æ–¹å¼ï¼šæŸ¥è¯¢äº§å“æ—¶ï¼Œå¯ä»¥ç›´æ¥è·å–é›¶ä»¶çš„åç§°
æˆ‘å°±ç›´æ¥æŠŠåç§°æ”¾å…¥productsè¡¨ä¸­ã€‚
```MongoDB
db.products.findOne()
{
    name : 'left-handed smoke shifter',
    manufacturer : 'Acme Corp',
    catalog_number: 1234,
    parts : [
        { id : ObjectID('AAAA'), name : '#4 grommet' },         // Part name is denormalized
        { id: ObjectID('F17C'), name : 'fan blade assembly' },
        { id: ObjectID('D2AA'), name : 'power switch' },
        // etc
    ]
}
```
è¿™è¦è€ƒè™‘å…·ä½“åœºæ™¯ä¸‹è¯»å†™æ¯”ä¾‹ï¼Œå¯¹äº â€œmanyâ€ sideï¼Œå¦‚æœæ˜¯è¯»å¤šå†™å°‘ï¼ˆè¯»å†™æ¯”ä¾‹å¾ˆé«˜ï¼‰çš„åœºæ™¯ï¼Œæ¯”è¾ƒåˆé€‚ã€‚ä½†æ˜¯ï¼Œå¯¹äºå†™/æ›´æ–°åç§°æ¯”è¾ƒé¢‘ç¹çš„åœºæ™¯ï¼Œå°±ä¸å¤ªé€‚åˆã€‚
åèŒƒå¼ one to many çš„ä¾‹å­å’Œ many to one çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯â€œåèŒƒå¼â€çš„ä½“ç°ã€‚
æ€»ç»“ï¼š
å¦‚æœåŒå‘å¼•ç”¨èƒ½å¤Ÿä¼˜åŒ–ä½ çš„æ¨¡å¼ï¼Œå¹¶ä¸”ä½ æ„¿æ„ä»˜å‡ºæ²¡æœ‰**åŸå­æ›´æ–°çš„ä»£ä»·**ï¼Œä½ å¯ä»¥ä½¿ç”¨åŒå‘å¼•ç”¨ã€‚
å¦‚æœä½ æ­£åœ¨å¼•ç”¨ï¼Œä½ å¯ä»¥å°†æ•°æ®ä» â€œone " side -\> "N â€œ sideï¼Œæˆ–è€…ä» "N " sideè½¬åˆ° â€œone â€œsideï¼Œè¿›è¡ŒèŒƒå¼ã€‚


å¼•ç”¨ï¼š[https://www.mongodb.com/blog/post/6-rules-of-thumb-for-mongodb-schema-design-part-3][1]

[1]:	https://www.mongodb.com/blog/post/6-rules-of-thumb-for-mongodb-schema-design-part-3